<!DOCTYPE html>
<html lang="en">
<!-- [Previous head and styles remain the same] -->
<body>
  <!-- [Previous HTML remains the same] -->

  <script>
    // [Previous constants and most functions remain the same until processQueueUpdate]

    async function processQueueUpdate(update, token) {
      const { userId, queueId } = update;
      
      // Use CORS proxy
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
      const apiUrl = `https://api.mypurecloud.ie/api/v2/users/${userId}/routingqueues/${queueId}/members`;
      
      const body = {
        id: queueId,
        member: {
          id: userId,
          name: availableAgents.find(agent => agent.id === userId)?.name || 'Unknown'
        }
      };
      
      try {
        const response = await fetch(proxyUrl + apiUrl, {
          method: 'POST',
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest" // Required by some CORS proxies
          },
          body: JSON.stringify(body)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || "Failed to update queue membership");
        }
        
        return response.json();
      } catch (error) {
        console.error("API Error:", error);
        // If proxy fails, try direct (might work for some users)
        try {
          const directResponse = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
          });
          
          if (!directResponse.ok) {
            const errorData = await directResponse.json();
            throw new Error(errorData.message || "Direct connection failed");
          }
          
          return directResponse.json();
        } catch (directError) {
          throw new Error("Both proxy and direct connections failed. Please try again or contact support.");
        }
      }
    }
  </script>
</body>
</html>
