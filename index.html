<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1400px;
      background:var(--light-bg);color:var(--text-color);
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}

    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;align-items:end
    }

    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .loading{opacity:.6;pointer-events:none}

    /* === SELECTION SECTION === */
    .selection-section{
      margin-bottom:20px;
      padding:15px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background-color:var(--light-bg);
    }
    .selection-section h3{
      margin-top:0;color:var(--primary-color);
    }

    /* === UPDATED TABS (MATCHING YOUR OTHER TOOL) === */
    .tab-container{
      display:flex;
      margin-bottom:20px;
      border-bottom:1px solid var(--border-color);
    }

    .tab{
      padding:12px 24px;
      cursor:pointer;
      margin-right:4px;
      border-radius:8px 8px 0 0;
      background:#ffffff;
      border:2px solid var(--primary-color);
      border-bottom:none;
      color:var(--primary-color);
      font-weight:600;
      transition:background .2s, color .2s;
    }

    .tab:hover{
      background:var(--pill);
    }

    .tab.active{
      background:var(--primary-color);
      color:#ffffff;
      border-color:var(--primary-color);
    }

    .tab-content{display:none}
    .tab-content.active{display:block}

    /* === TABLE === */
    table{
      width:100%;border-collapse:collapse;margin-top:20px;
    }
    th,td{
      border:1px solid var(--border-color);
      padding:10px;text-align:left;vertical-align:top;
    }
    th{background-color:var(--primary-color);color:white}

    .select-all-checkbox{margin-bottom:10px}

    .error-message{
      color:#d9534f;padding:10px;margin:10px 0;
      border:1px solid #d9534f;border-radius:4px;background:#f9f2f2;
    }
    .success-message{
      color:#3c763d;padding:10px;margin:10px 0;
      border:1px solid #3c763d;border-radius:4px;background:#dff0d8;
    }

    /* === BULK QUEUE SECTION === */
    .bulk-section{
      background:#f8f9fa;padding:20px;border-radius:8px;
      border:1px solid #dee2e6;margin-bottom:24px;
      display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start;
    }
    .bulk-queue-selector{min-width:300px}
    .bulk-action{min-width:180px;display:flex;flex-direction:column;gap:10px}

    .small-btn{padding:8px 16px;font-size:14px}
    .tiny-btn{padding:4px 10px;font-size:12px;min-width:32px}

    .selected-queues-display{
      margin-top:8px;padding:10px;background:#fff;
      border:1px solid #dee2e6;border-radius:6px;
      max-height:100px;overflow-y:auto;font-size:13px
    }
    .selected-queue-item{
      display:inline-block;background:var(--pill);
      border:1px solid var(--border-color);
      border-radius:4px;padding:4px 8px;margin:2px;font-size:12px
    }
    .refresh-btn{background:#6c757d;margin-top:8px}
    .refresh-btn:hover{background:#5a6268}

    /* === CHECKBOX DROPDOWN === */
    .checkbox-dropdown{position:relative;min-width:240px;width:100%}
    .cd-trigger{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--border-color);border-radius:6px;
      background:#fff;padding:10px;cursor:pointer;width:100%;
    }
    .cd-trigger .label{color:var(--text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{
      background:var(--pill);border:1px solid var(--border-color);
      border-radius:999px;padding:2px 8px;font-size:12px;
      color:#2c3e50;flex-shrink:0;margin-left:8px
    }

    .cd-panel{
      position:absolute;z-index:1000;margin-top:6px;background:#fff;
      border:1px solid var(--border-color);border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;
      max-height:340px;overflow:hidden;display:none
    }
    .cd-panel.open{display:block}

    .cd-header{
      padding:10px;border-bottom:1px solid var(--border-color);
      display:flex;gap:8px;align-items:center
    }
    .cd-search{
      flex:1;border:1px solid var(--border-color);border-radius:6px;
      padding:8px;width:100%;box-sizing:border-box
    }
    .cd-actions button{
      background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);
      border-radius:6px;padding:8px 10px;cursor:pointer;
    }

    .cd-selectall{
      padding:8px 12px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;gap:10px
    }

    .cd-list{max-height:260px;overflow:auto}
    .cd-item{
      display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-bottom:1px solid #f1f3f5
    }

    .cd-footer{
      padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);
      font-size:12px;color:var(--text-light);display:flex;justify-content:space-between
    }

    @media (max-width:1200px){
      .controls{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
      .bulk-section{grid-template-columns:1fr}
    }
    @media (max-width:768px){
      .controls{grid-template-columns:1fr}
      .bulk-section{grid-template-columns:1fr;gap:15px}
      .bulk-action{min-width:100%}
    }
  </style>
</head>
<body>

  <div id="loginSection" class="card" style="text-align:center;margin:20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer" style="display:none;"></div>

    <div class="tab-container">
      <div class="tab active" data-tab="remove">Remove Queues</div>
      <div class="tab" data-tab="add">Add Queues</div>
    </div>

    <!-- REMOVE TAB -->
    <div id="removeTab" class="tab-content active">

      <div class="selection-section">
        <h3>Search Options</h3>

        <div class="controls">
          <div><label>Select Management Units</label><div id="managementUnitDropdownRemove" class="checkbox-dropdown"></div></div>
          <div><label>Select Agents</label><div id="agentDropdownRemove" class="checkbox-dropdown"></div></div>
          <div><label>Select Queues</label><div id="queueDropdownRemove" class="checkbox-dropdown"></div></div>
          <div><label>Select Work Teams</label><div id="teamDropdownRemove" class="checkbox-dropdown"></div></div>
          <div><label>&nbsp;</label><button id="fetchUsersRemove" class="full-width-btn">Get Users</button></div>
        </div>

        <div class="muted">Make your selections above and click Get Users</div>
      </div>

      <div class="card">
        <div class="bulk-section">
          <div class="bulk-queue-selector">
            <label>Apply to All Selected Users</label>
            <div id="bulkQueueRemoveDropdown" class="checkbox-dropdown"></div>
            <div class="selected-queues-display" id="bulkRemoveDisplay">
              <div class="muted">No queues selected</div>
            </div>
          </div>

          <div class="bulk-action">
            <button id="applyBulkRemove" class="full-width-btn small-btn">Apply to Selected Users</button>
            <button id="refreshRemove" class="full-width-btn small-btn refresh-btn">Refresh View</button>
          </div>
        </div>

        <h2>Queue Assignments - Remove</h2>

        <table id="userQueuesTableRemove">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersRemove" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Queues Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button id="removeQueues" class="full-width-btn" disabled>Remove Selected Queues from Selected Users</button>
      </div>
    </div>

    <!-- ADD TAB -->
    <div id="addTab" class="tab-content">

      <div class="selection-section">
        <h3>Search Options</h3>

        <div class="controls">
          <div><label>Select Management Units</label><div id="managementUnitDropdownAdd" class="checkbox-dropdown"></div></div>
          <div><label>Select Agents</label><div id="agentDropdownAdd" class="checkbox-dropdown"></div></div>
          <div><label>Select Queues</label><div id="queueDropdownAdd" class="checkbox-dropdown"></div></div>
          <div><label>Select Work Teams</label><div id="teamDropdownAdd" class="checkbox-dropdown"></div></div>
          <div><label>&nbsp;</label><button id="fetchUsersAdd" class="full-width-btn">Get Users</button></div>
        </div>

        <div class="muted">Filtered by queues? Users missing that queue will be highlighted.</div>
      </div>

      <div class="card">

        <div class="bulk-section">
          <div class="bulk-queue-selector">
            <label>Apply to All Selected Users</label>
            <div id="bulkQueueAddDropdown" class="checkbox-dropdown"></div>
            <div class="selected-queues-display" id="bulkAddDisplay">
              <div class="muted">No queues selected</div>
            </div>
          </div>

          <div class="bulk-action">
            <button id="applyBulkAdd" class="full-width-btn small-btn">Apply to Selected Users</button>
            <button id="refreshAdd" class="full-width-btn small-btn refresh-btn">Refresh View</button>
          </div>
        </div>

        <h2>Queue Assignments - Add</h2>

        <table id="userQueuesTableAdd">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsersAdd" class="select-all-checkbox"></th>
              <th>Agent</th>
              <th>Queues Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button id="addQueues" class="full-width-btn" disabled>Add Selected Queues to Selected Users</button>
      </div>
    </div>

  </div>

  <script>
    /********* OAuth + Global Vars *********/
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Queue-updater/';
    const oauthUrl =
      `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    let token = null;
    let availableUsers = [];
    let availableQueues = [];
    let availableTeams = [];
    let availableManagementUnits = [];

    const sharedSelections = {
      agentIds: [], queueIds: [], teamIds: [], managementUnitIds: []
    };

    let currentFetchedData = {
      usersWithQueues: [],
      queueIds: []
    };

    const dd = {
      agent:{remove:null,add:null},
      queue:{remove:null,add:null},
      team:{remove:null,add:null},
      managementUnit:{remove:null,add:null}
    };

    const bulkDd = { remove:null, add:null };

    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get("access_token");

      if (!token) {
        window.location.href = oauthUrl;
        return;
      }

      document.getElementById("loginSection").style.display = "none";
      document.getElementById("appContent").style.display = "block";

      initializeApp(token);
    });

    function showMessage(message, type='error'){
      const msgBox = document.getElementById('messageContainer');
      msgBox.innerHTML = `<div class="${type}-message">${message}</div>`;
      msgBox.style.display = 'block';
      if (type === 'success') setTimeout(() => (msgBox.style.display='none'), 5000);
    }

    function authHeaders(){
      return { Authorization:`Bearer ${token}`, "Content-Type":"application/json" };
    }

    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    /********* INITIAL LOAD *********/
    async function initializeApp(){
      try {
        await Promise.all([
          fetchAllUsers(), fetchAllQueues(),
          fetchAllTeams(), fetchAllManagementUnits()
        ]);

        createAllDropdowns();
        createBulkDropdowns();
        populateDropdownOptions();
        setupEventListeners();
        setupBulkControls();

      } catch (e){
        showMessage("Error initialising. Redirecting...");
        setTimeout(()=> window.location.href = oauthUrl, 2000);
      }
    }

    /********* DATA LOADERS *********/
    async function fetchAllUsers(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/users?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      availableUsers = all;
    }

    async function fetchAllQueues(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/routing/queues?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      availableQueues = all;
    }

    async function fetchAllTeams(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/teams?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      availableTeams = all;
    }

    async function fetchAllManagementUnits(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      availableManagementUnits = all;
    }

    /********* CHECKBOX DROPDOWNS *********/
    function createCheckboxDropdown(containerId,{placeholder,searchPlaceholder},mode,isBulk=false){
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className='cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className='cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options=[], selected=new Set();

      function render(filter=''){
        const ft = filter.toLowerCase().trim();
        list.innerHTML='';
        const filtered = !ft ? options : options.filter(o => (o.label||'').toLowerCase().includes(ft));

        if (!filtered.length){
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`;
          return;
        }

        filtered.forEach(o=>{
          const id = `${containerId}_${o.value}`;
          const row = document.createElement('div');
          row.className='cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/>
              <span>${o.label}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change',()=>{
            cb.checked ? selected.add(o.value) : selected.delete(o.value);
            updateSummary(); updateSelectAllState();
            if (mode) updateSharedSelections(containerId,[...selected],mode);
            if (isBulk) updateBulkQueueDisplay();
          });
          list.appendChild(row);
        });
      }

      function updateSummary(){
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }

      function updateSelectAllState(){
        const total = options.length;
        selectAll.indeterminate = selected.size>0 && selected.size<total;
        selectAll.checked = total>0 && selected.size===total;
      }

      trigger.addEventListener('click',()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click',e=>{ if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input',()=>render(search.value));

      clearBtn.addEventListener('click',()=>{
        selected.clear();
        render(search.value);
        updateSummary(); updateSelectAllState();
        if (mode) updateSharedSelections(containerId,[],mode);
        if (isBulk) updateBulkQueueDisplay();
      });

      selectAll.addEventListener('change',()=>{
        if (selectAll.checked) options.forEach(o=>selected.add(o.value));
        else selected.clear();
        render(search.value); updateSummary();
        if (mode) updateSharedSelections(containerId,[...selected],mode);
        if (isBulk) updateBulkQueueDisplay();
      });

      function setOptions(arr){
        options = arr||[];
        [...selected].forEach(v=>{ if(!options.some(o=>o.value===v)) selected.delete(v) });
        render(search.value); updateSummary(); updateSelectAllState();
      }

      function getSelectedValues(){ return [...selected] }

      function setSelectedValues(vals){
        selected = new Set(vals);
        render(search.value); updateSummary(); updateSelectAllState();
      }

      render();

      return { setOptions, getSelectedValues, setSelectedValues };
    }

    function createAllDropdowns(){
      dd.agent.remove = createCheckboxDropdown('agentDropdownRemove',{placeholder:'Select agents',searchPlaceholder:'Search agents...'},'remove');
      dd.agent.add    = createCheckboxDropdown('agentDropdownAdd',{placeholder:'Select agents',searchPlaceholder:'Search agents...'},'add');

      dd.queue.remove = createCheckboxDropdown('queueDropdownRemove',{placeholder:'Select queues',searchPlaceholder:'Search queues...'},'remove');
      dd.queue.add    = createCheckboxDropdown('queueDropdownAdd',{placeholder:'Select queues',searchPlaceholder:'Search queues...'},'add');

      dd.team.remove  = createCheckboxDropdown('teamDropdownRemove',{placeholder:'Select teams',searchPlaceholder:'Search teams...'},'remove');
      dd.team.add     = createCheckboxDropdown('teamDropdownAdd',{placeholder:'Select teams',searchPlaceholder:'Search teams...'},'add');

      dd.managementUnit.remove = createCheckboxDropdown('managementUnitDropdownRemove',{placeholder:'Select management units',searchPlaceholder:'Search management units...'},'remove');
      dd.managementUnit.add    = createCheckboxDropdown('managementUnitDropdownAdd',{placeholder:'Select management units',searchPlaceholder:'Search management units...'},'add');
    }

    function createBulkDropdowns(){
      bulkDd.remove = createCheckboxDropdown('bulkQueueRemoveDropdown',{placeholder:'Select queues to remove',searchPlaceholder:'Search queues...'},null,true);
      bulkDd.add    = createCheckboxDropdown('bulkQueueAddDropdown',{placeholder:'Select queues to add',searchPlaceholder:'Search queues...'},null,true);
    }

    function populateDropdownOptions(){
      const validUsers = availableUsers
        .filter(u => u.name && u.name.trim() && u.name !== 'Unknown User')
        .map(u => ({value:u.id,label:u.name}))
        .sort((a,b)=>a.label.localeCompare(b.label));

      dd.agent.remove.setOptions(validUsers);
      dd.agent.add.setOptions(validUsers);

      const queueOpts = availableQueues
        .map(q => ({value:q.id,label:q.name}))
        .sort((a,b)=>a.label.localeCompare(b.label));

      dd.queue.remove.setOptions(queueOpts);
      dd.queue.add.setOptions(queueOpts);

      bulkDd.remove.setOptions(queueOpts);
      bulkDd.add.setOptions(queueOpts);

      const teamOpts = availableTeams
        .map(t => ({value:t.id,label:t.name}))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.team.remove.setOptions(teamOpts);
      dd.team.add.setOptions(teamOpts);

      const muOpts = availableManagementUnits
        .map(mu => ({value:mu.id,label:mu.name}))
        .sort((a,b)=>a.label.localeCompare(b.label));
      dd.managementUnit.remove.setOptions(muOpts);
      dd.managementUnit.add.setOptions(muOpts);
    }

    /********* BULK DISPLAY *********/
    function updateBulkQueueDisplay(){
      updateQueueDisplay(document.getElementById('bulkRemoveDisplay'), bulkDd.remove.getSelectedValues());
      updateQueueDisplay(document.getElementById('bulkAddDisplay'), bulkDd.add.getSelectedValues());
    }

    function updateQueueDisplay(el, queueIds){
      if (!queueIds.length){
        el.innerHTML = `<div class="muted">No queues selected</div>`;
        return;
      }
      el.innerHTML = queueIds.map(id=>{
        const q = availableQueues.find(q=>q.id===id);
        return `<div class="selected-queue-item">${q ? q.name : id}</div>`;
      }).join('');
    }

    /********* SHARED SELECTIONS *********/
    function updateSharedSelections(dropId,values,mode){
      if (dropId.includes("agentDropdown")){
        sharedSelections.agentIds = values;
        if (mode !== 'remove') dd.agent.remove.setSelectedValues(values);
        if (mode !== 'add') dd.agent.add.setSelectedValues(values);
      }
      if (dropId.includes("queueDropdown")){
        sharedSelections.queueIds = values;
        if (mode !== 'remove') dd.queue.remove.setSelectedValues(values);
        if (mode !== 'add') dd.queue.add.setSelectedValues(values);
      }
      if (dropId.includes("teamDropdown")){
        sharedSelections.teamIds = values;
        if (mode !== 'remove') dd.team.remove.setSelectedValues(values);
        if (mode !== 'add') dd.team.add.setSelectedValues(values);
      }
      if (dropId.includes("managementUnitDropdown")){
        sharedSelections.managementUnitIds = values;
        if (mode !== 'remove') dd.managementUnit.remove.setSelectedValues(values);
        if (mode !== 'add') dd.managementUnit.add.setSelectedValues(values);
      }
    }

    function syncSelectionsToCurrentTab(mode){
      dd.agent[mode].setSelectedValues(sharedSelections.agentIds);
      dd.queue[mode].setSelectedValues(sharedSelections.queueIds);
      dd.team[mode].setSelectedValues(sharedSelections.teamIds);
      dd.managementUnit[mode].setSelectedValues(sharedSelections.managementUnitIds);

      updateBulkQueueDisplay();

      if (currentFetchedData.usersWithQueues.length)
        populateTableForTab(mode);
    }

    function populateTableForTab(mode){
      if (!currentFetchedData.usersWithQueues.length) return;
      if (mode === 'remove') populateRemoveTable(currentFetchedData.usersWithQueues);
      else populateAddTable(currentFetchedData.usersWithQueues, currentFetchedData.queueIds);
    }

    /********* BULK BUTTONS *********/
    function setupBulkControls(){
      document.getElementById('applyBulkRemove').addEventListener('click',applyBulkRemove);
      document.getElementById('refreshRemove').addEventListener('click',()=>refreshCurrentView('remove'));

      document.getElementById('applyBulkAdd').addEventListener('click',applyBulkAdd);
      document.getElementById('refreshAdd').addEventListener('click',()=>refreshCurrentView('add'));
    }

    async function refreshCurrentView(mode){
      if (!currentFetchedData.usersWithQueues.length){
        showMessage("No data to refresh");
        return;
      }
      await fetchUsers(mode);
      showMessage("View refreshed","success");
    }

    /********* TAB SWITCHING *********/
    function setupEventListeners(){
      document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));

          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + "Tab").classList.add('active');

          syncSelectionsToCurrentTab(tab.dataset.tab);
        });
      });

      document.getElementById('fetchUsersRemove').addEventListener('click',()=>fetchUsers('remove'));
      document.getElementById('removeQueues').addEventListener('click',removeSelectedQueues);

      document.getElementById('fetchUsersAdd').addEventListener('click',()=>fetchUsers('add'));
      document.getElementById('addQueues').addEventListener('click',addSelectedQueues);

      document.getElementById('selectAllUsersRemove').addEventListener('change',function(){
        document.querySelectorAll('#userQueuesTableRemove tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateRemoveButtonState();
      });

      document.getElementById('selectAllUsersAdd').addEventListener('change',function(){
        document.querySelectorAll('#userQueuesTableAdd tbody input[type="checkbox"]').forEach(cb=>cb.checked=this.checked);
        updateAddButtonState();
      });
    }

    /********* FILTER LOGIC *********/
    async function fetchUsers(mode){
      const agentIds = dd.agent[mode].getSelectedValues();
      const queueIds = dd.queue[mode].getSelectedValues();
      const teamIds  = dd.team[mode].getSelectedValues();
      const muIds    = dd.managementUnit[mode].getSelectedValues();

      if (!agentIds.length && !queueIds.length && !teamIds.length && !muIds.length){
        showMessage("Please select at least one filter");
        return;
      }

      const tbody = document.querySelector(`#userQueuesTable${cap(mode)} tbody`);
      tbody.innerHTML = `<tr><td colspan="4" class="loading">Loading...</td></tr>`;

      const validUsers = availableUsers.filter(u=>u.name && u.name.trim() && u.name!=="Unknown User");
      let users=[];

      if (agentIds.length){
        users = agentIds.map(id=>validUsers.find(u=>u.id===id)).filter(Boolean);
      }

      else if (queueIds.length){
        const allMembers = (await Promise.all(queueIds.map(id=>fetchQueueMembers(id)))).flat();
        const proc = await Promise.all(allMembers.map(m=>processQueueMember(m)));
        users = Array.from(new Map(proc.filter(Boolean).map(u=>[u.id,u])).values());
      }

      else if (teamIds.length){
        const allMembers = (await Promise.all(teamIds.map(id=>fetchTeamMembers(id)))).flat();
        const proc = await Promise.all(allMembers.map(m=>processTeamMember(m)));
        users = Array.from(new Map(proc.filter(Boolean).map(u=>[u.id,u])).values());
      }

      else if (muIds.length){
        const allMembers = (await Promise.all(muIds.map(id=>fetchManagementUnitUsers(id)))).flat();
        const proc = await Promise.all(allMembers.map(m=>processManagementUnitUser(m)));
        users = Array.from(new Map(proc.filter(Boolean).map(u=>[u.id,u])).values());
      }

      if (!users.length){
        tbody.innerHTML = `<tr><td colspan="4">No users found</td></tr>`;
        showMessage("No users found for selected criteria");
        return;
      }

      const usersWithQueues = await Promise.all(
        users.map(async user=>{
          const queues = await fetchUserQueues(user.id);
          return {user, queues};
        })
      );

      let filtered = usersWithQueues;

      if (queueIds.length){
        if (mode==='remove'){
          filtered = usersWithQueues.filter(({queues})=>queues.some(q=>queueIds.includes(q.id)));
        } else {
          filtered = usersWithQueues.filter(({queues})=>queueIds.some(id=>!queues.some(q=>q.id===id)));
        }
      }

      currentFetchedData = { usersWithQueues:filtered, queueIds };
      populateRemoveTable(filtered);
      populateAddTable(filtered, queueIds);
    }

    /********* QUEUE MEMBERS *********/
    async function fetchQueueMembers(queueId){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/routing/queues/${queueId}/members?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      return all;
    }

    async function processQueueMember(member){
      const userId = member?.user?.id;
      if (!userId) return null;
      const user = availableUsers.find(u=>u.id===userId);
      return user && user.name ? user : null;
    }

    /********* TEAM MEMBERS *********/
    async function fetchTeamMembers(teamId){
      const res = await fetch(
        `https://api.mypurecloud.ie/api/v2/teams/${teamId}/members`,
        {headers:authHeaders()}
      );
      const data = await res.json();
      return data.entities||[];
    }

    async function processTeamMember(member){
      const id = member?.id;
      if (!id) return null;
      const user = availableUsers.find(u=>u.id===id);
      return user && user.name ? user : null;
    }

    /********* MANAGEMENT UNIT MEMBERS *********/
    async function fetchManagementUnitUsers(muId){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits/${muId}/users?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total=data.total||0; page++;
      } while(all.length < total);
      return all;
    }

    async function processManagementUnitUser(member){
      const id = member?.id;
      const user = availableUsers.find(u=>u.id===id);
      return user && user.name ? user : null;
    }

    /********* USER QUEUES *********/
    async function fetchUserQueues(userId){
      try{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/users/${userId}/queues`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        return data.entities||[];
      } catch{
        return [];
      }
    }

    /********* TABLES *********/
    function populateRemoveTable(list){
      const tbody = document.querySelector('#userQueuesTableRemove tbody');
      tbody.innerHTML = '';

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="4">No users found</td></tr>`;
        updateRemoveButtonState();
        return;
      }

      list.forEach(({user,queues})=>{
        const opts = queues.length
          ? ['<option value="">Select Queue to Remove</option>',
             ...queues.map(q=>`<option value="${q.id}">${q.name}</option>`)]
          : ['<option value="">No Queues Assigned</option>'];

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="user-checkbox-remove" data-user-id="${user.id}"></td>
          <td>${user.name}</td>
          <td>${queues.length ? queues.map(q=>q.name).join(', ') : 'No Queues'}</td>
          <td>
            <select class="queue-select-remove" data-user-id="${user.id}" ${queues.length?'':'disabled'}>
              ${opts.join('')}
            </select>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.user-checkbox-remove').forEach(cb=>{
        cb.addEventListener('change',updateRemoveButtonState);
      });
      document.querySelectorAll('.queue-select-remove').forEach(sel=>{
        sel.addEventListener('change',updateRemoveButtonState);
      });

      updateRemoveButtonState();
    }

    function updateRemoveButtonState(){
      const btn = document.getElementById('removeQueues');
      const checkedUsers = [...document.querySelectorAll('.user-checkbox-remove:checked')];
      let ok = false;

      checkedUsers.forEach(u=>{
        const id = u.getAttribute('data-user-id');
        const select = document.querySelector(`.queue-select-remove[data-user-id="${id}"]`);
        if (select && select.value) ok = true;
      });

      btn.disabled = !ok;
    }

    function populateAddTable(list, selectedQueueIds=[]){
      const tbody = document.querySelector('#userQueuesTableAdd tbody');
      tbody.innerHTML = '';

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="4">No users found</td></tr>`;
        updateAddButtonState();
        return;
      }

      list.forEach(({user,queues})=>{
        const assigned = queues.map(q=>q.id);
        const choices = availableQueues.filter(q=>!assigned.includes(q.id));

        const preselect = selectedQueueIds.find(id=>choices.some(c=>c.id===id)) || '';

        const opts = choices.length
          ? ['<option value="">Select Queue to Add</option>',
             ...choices.map(q=>`<option value="${q.id}" ${q.id===preselect?'selected':''}>${q.name}</option>`)]
          : ['<option value="">All Queues Assigned</option>'];

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="user-checkbox-add" data-user-id="${user.id}"></td>
          <td>${user.name}</td>
          <td>${queues.length ? queues.map(q=>q.name).join(', ') : 'No Queues'}</td>
          <td>
            <select class="queue-select-add" data-user-id="${user.id}" ${choices.length?'':'disabled'}>
              ${opts.join('')}
            </select>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.querySelectorAll('.user-checkbox-add').forEach(cb=>{
        cb.addEventListener('change',updateAddButtonState);
      });
      document.querySelectorAll('.queue-select-add').forEach(sel=>{
        sel.addEventListener('change',updateAddButtonState);
      });

      updateAddButtonState();
    }

    function updateAddButtonState(){
      const btn = document.getElementById('addQueues');
      const checkedUsers = [...document.querySelectorAll('.user-checkbox-add:checked')];
      let ok = checkedUsers.length>0;

      checkedUsers.forEach(u=>{
        const id = u.getAttribute('data-user-id');
        const select = document.querySelector(`.queue-select-add[data-user-id="${id}"]`);
        if (!select || !select.value) ok = false;
      });

      btn.disabled = !ok;
    }

    /********* REMOVE QUEUE *********/
    async function removeSelectedQueues(){
      const checked = [...document.querySelectorAll('.user-checkbox-remove:checked')];
      const ops=[];

      checked.forEach(cb=>{
        const user = cb.getAttribute('data-user-id');
        const sel = document.querySelector(`.queue-select-remove[data-user-id="${user}"]`);
        if (sel && sel.value) ops.push({userId:user, queueId:sel.value});
      });

      if (!ops.length){
        showMessage("No valid operations");
        return;
      }

      const btn = document.getElementById('removeQueues');
      btn.disabled = true;
      btn.textContent = "Processing...";

      const results = await Promise.allSettled(
        ops.map(op=>removeQueueFromUser(op.userId,op.queueId))
      );

      const fails = results.filter(r=>r.status==='rejected');

      if (fails.length){
        showMessage(`${fails.length} failures occurred`);
      } else {
        const queueNames = [...new Set(
          ops.map(op=>{
            const q=availableQueues.find(q=>q.id===op.queueId);
            return q ? q.name : op.queueId;
          })
        )].join(', ');
        showMessage(`Successfully removed queue(s): ${queueNames}`,'success');
      }

      btn.disabled=false;
      btn.textContent = "Remove Selected Queues from Selected Users";

      await fetchUsers('remove');
    }

    async function removeQueueFromUser(userId,queueId){
      const res = await fetch(
        `https://api.mypurecloud.ie/api/v2/routing/queues/${queueId}/members/${userId}`,
        {method:'DELETE',headers:authHeaders()}
      );
      if (!res.ok) throw new Error("Remove failed");
    }

    /********* ADD QUEUE *********/
    async function addSelectedQueues(){
      const checked=[...document.querySelectorAll('.user-checkbox-add:checked')];
      const ops=[];

      checked.forEach(cb=>{
        const user=cb.getAttribute('data-user-id');
        const sel=document.querySelector(`.queue-select-add[data-user-id="${user}"]`);
        if (sel && sel.value) ops.push({userId:user,queueId:sel.value});
      });

      if (!ops.length){
        showMessage("No valid operations");
        return;
      }

      const btn=document.getElementById('addQueues');
      btn.disabled=true;
      btn.textContent="Processing...";

      const results = await Promise.allSettled(
        ops.map(op=>addQueueToUser(op.userId,op.queueId))
      );

      const fails = results.filter(r=>r.status==='rejected');
      if (fails.length){
        showMessage(`${fails.length} failures occurred`);
      } else {
        const queueNames = [...new Set(
          ops.map(op=>{
            const q=availableQueues.find(q=>q.id===op.queueId);
            return q ? q.name : op.queueId;
          })
        )].join(', ');
        showMessage(`Successfully added queue(s): ${queueNames}`,'success');
      }

      btn.disabled=false;
      btn.textContent="Add Selected Queues to Selected Users";

      await fetchUsers('add');
    }

    async function addQueueToUser(userId,queueId){
      const res = await fetch(
        `https://api.mypurecloud.ie/api/v2/routing/queues/${queueId}/members`,
        {
          method:'POST',
          headers:authHeaders(),
          body:JSON.stringify([{id:userId}])
        }
      );
      if (!res.ok) throw new Error("Add failed");
    }

  </script>
</body>
</html>
